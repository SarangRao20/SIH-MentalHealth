<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}MindCare - Mental Health Support{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">

    {% block extra_head %}{% endblock %}
</head>
<body>
    <!-- Professional Sidebar -->
    <nav id="sidebar" class="sidebar d-flex flex-column">
        <!-- Sidebar Header -->
        <div class="sidebar-header">
            <div class="logo-section">
                <a class="navbar-brand d-flex align-items-center" href="{{ url_for('index') }}">
                    <div class="logo-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="logo-text">
                        <span class="brand-name">MindCare</span>
                        <span class="brand-tagline">Mental Health Platform</span>
                    </div>
                </a>
            </div>
            <button class="btn-toggle-sidebar" id="sidebarCollapse">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>

        <!-- Menu -->
        <ul class="list-unstyled sidebar-menu flex-grow-1 mt-3">
    {% if current_user.is_authenticated %}
        {% if current_user.role == 'counsellor' %}
            <li>
                <a href="{{ url_for('counsellor_dashboard') }}">
                    <i class="fas fa-tachometer-alt icon"></i>
                    <span class="label">{{ _('Dashboard') }}</span>
                </a>
            </li>
            <!-- Hide all student features for counsellor role -->
        {% else %}
            <li>
                <a href="{{ url_for('dashboard') }}">
                    <i class="fas fa-tachometer-alt icon"></i>
                    <span class="label">{{ _('Dashboard') }}</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('chatbot') }}">
                    <img id="chatbot-icon" src="{{ url_for('static', filename='images/bot.png') }}" alt="Chatbot Icon" class="icon" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 10px;">
                    <span class="label">{{ _('Chat Support') }}</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('assessments') }}">
                    <i class="fas fa-clipboard-list icon"></i>
                    <span class="label">{{ _('Assessments') }}</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('meditation') }}">
                    <i class="fas fa-leaf icon"></i>
                    <span class="label">{{ _('Meditation') }}</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('vr_meditation') }}">
                    <i class="fas fa-vr-cardboard icon"></i>
                    <span class="label">ðŸ¥½ VR Meditation</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('ar_breathing') }}">
                    <i class="fas fa-mobile-alt icon"></i>
                    <span class="label">ðŸ“± AR Breathing</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('resources') }}">
                    <i class="fas fa-book-medical icon"></i>
                    <span class="label">{{ _('Resources') }}</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('venting_room') }}">
                    <i class="fas fa-fire icon"></i>
                    <span class="label">{{ _('Private Venting Room') }}</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('sound_venting') }}">
                    <i class="fas fa-microphone icon"></i>
                    <span class="label">ðŸŽ¤ Sound Venting</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('venting_hall') }}">
                    <i class="fas fa-users icon"></i>
                    <span class="label">{{ _('Community Support') }}</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('consultation') }}">
                    <i class="fas fa-user-md icon"></i>
                    <span class="label">{{ _('Consultation') }}</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('routine') }}">
                    <i class="fas fa-calendar-alt icon"></i>
                    <span class="label">{{ _('Routine') }}</span>
                </a>
            </li>
            {% if current_user.role in ['teacher', 'admin'] %}
            <li>
                <a href="{{ url_for('mentor_dashboard') }}">
                    <i class="fas fa-chart-bar icon"></i>
                    <span class="label">{{ _('Mentor Dashboard') }}</span>
                </a>
            </li>
            {% endif %}
        {% endif %}
    {% endif %}
</ul>

        <!-- Professional Footer -->
        <div class="sidebar-footer">
            {% if current_user.is_authenticated %}
                <!-- User Profile Card -->
                <div class="user-profile-card">
                    <div class="user-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="user-details">
                        <div class="username">{{ current_user.username }}</div>
                        <div class="user-role">{{ current_user.role|title if current_user.role else 'User' }}</div>
                        {% if current_user.login_streak > 0 %}
                            <div class="streak-badge">
                                <i class="fas fa-fire"></i>
                                <span>{{ current_user.login_streak }} {{ _('days') }}</span>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="footer-actions">
                    <!-- Language Switcher -->
                    <div class="language-switcher">
                        <div class="language-toggle">
                            <a href="{{ url_for('set_language', language='en') }}" 
                               class="lang-btn {% if session.language == 'en' or not session.language %}active{% endif %}">
                                EN
                            </a>
                            <a href="{{ url_for('set_language', language='hi') }}" 
                               class="lang-btn {% if session.language == 'hi' %}active{% endif %}">
                                à¤¹à¤¿à¤‚
                            </a>
                        </div>
                    </div>

                    <!-- Logout Button -->
                    <a class="logout-btn" href="{{ url_for('logout') }}" title="{{ _('Logout') }}">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="label">{{ _('Logout') }}</span>
                    </a>
                </div>
            {% else %}
                <!-- Login/Register Buttons -->
                <div class="auth-buttons">
                    <a class="auth-btn login-btn" href="{{ url_for('login') }}">
                        <i class="fas fa-sign-in-alt"></i>
                        <span class="label">{{ _('Login') }}</span>
                    </a>
                    <a class="auth-btn register-btn" href="{{ url_for('register') }}">
                        <i class="fas fa-user-plus"></i>
                        <span class="label">{{ _('Register') }}</span>
                    </a>
                </div>
            {% endif %}
        </div>
    </nav>

    <!-- Mobile Menu Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn d-md-none" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Page Content -->
    <div id="content" class="content">

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
                    {% for category, message in messages %}
                        <div class="toast align-items-center text-bg-{{ 'danger' if category == 'error' else category }} border-0 show mb-2" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="d-flex">
                                <div class="toast-body">{{ message }}</div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Main Content Block -->
        <main class="container-fluid py-4">
            {% block content %}{% endblock %}
        </main>

        <!-- Footer -->
        <footer class="text-center py-4 mt-5">
            <p class="text-muted mb-2">
                <i class="fas fa-heart text-danger"></i>
                MindCare - Your Mental Health Companion
            </p>
            <p class="small text-muted">
                <strong>Crisis Hotlines:</strong>
                National Suicide Prevention Lifeline: 988 |
                Crisis Text Line: Text HOME to 741741
            </p>
        </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Professional Sidebar Toggle JS -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            'use strict';
            
            // Cache DOM elements
            const sidebar = document.getElementById("sidebar");
            const content = document.getElementById("content");
            const toggleBtn = document.getElementById("sidebarCollapse");
            const mobileMenuBtn = document.getElementById("mobileMenuBtn");
            const sidebarOverlay = document.getElementById("sidebarOverlay");
            
            // Debug: Check if elements exist
            console.log('Sidebar elements found:', {
                sidebar: !!sidebar,
                content: !!content,
                toggleBtn: !!toggleBtn,
                mobileMenuBtn: !!mobileMenuBtn
            });
            
            // Prevent errors if elements don't exist
            if (!sidebar || !toggleBtn) {
                console.warn('Required sidebar elements not found');
                return;
            }
            
            // Throttle function for performance
            function throttle(func, limit) {
                let inThrottle;
                return function() {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                }
            }
            
            // Desktop toggle functionality
            toggleBtn.addEventListener("click", function (e) {
                e.preventDefault();
                
                console.log('Toggle button clicked');
                
                // Add loading class to prevent multiple clicks
                toggleBtn.disabled = true;
                
                // Use requestAnimationFrame for smoother animation
                requestAnimationFrame(() => {
                    sidebar.classList.toggle("collapsed");
                    
                    const isCollapsed = sidebar.classList.contains("collapsed");
                    console.log('Sidebar collapsed state:', isCollapsed);
                    
                    // Re-enable button after animation completes
                    setTimeout(() => {
                        toggleBtn.disabled = false;
                    }, 300); // Match CSS transition duration
                });
                
                // Save collapsed state to localStorage with error handling
                try {
                    const isCollapsed = sidebar.classList.contains("collapsed");
                    localStorage.setItem("sidebarCollapsed", isCollapsed.toString());
                } catch (e) {
                    console.warn('Could not save sidebar state to localStorage:', e);
                }
            });

            // Mobile menu functionality
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener("click", function (e) {
                    e.preventDefault();
                    
                    // Prevent multiple rapid clicks
                    mobileMenuBtn.disabled = true;
                    
                    // Use requestAnimationFrame for smoother animation
                    requestAnimationFrame(() => {
                        sidebar.classList.add("show");
                        if (sidebarOverlay) sidebarOverlay.classList.add("show");
                        document.body.classList.add("sidebar-open");
                        
                        // Re-enable button after animation
                        setTimeout(() => {
                            mobileMenuBtn.disabled = false;
                        }, 300);
                    });
                });
            }

            // Close mobile menu function
            function closeMobileMenu() {
                sidebar.classList.remove("show");
                if (sidebarOverlay) sidebarOverlay.classList.remove("show");
                document.body.classList.remove("sidebar-open");
            }

            // Close mobile menu when clicking overlay
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener("click", closeMobileMenu);
            }

            // Close mobile menu when clicking menu item (mobile only)
            menuLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        closeMobileMenu();
                    }
                });
            });

            // Restore collapsed state on page load with error handling
            try {
                if (window.innerWidth > 768) {
                    const isCollapsed = localStorage.getItem("sidebarCollapsed") === "true";
                    console.log('Restoring sidebar state:', isCollapsed);
                    if (isCollapsed) {
                        sidebar.classList.add("collapsed");
                    }
                }
            } catch (e) {
                console.warn('Could not restore sidebar state from localStorage:', e);
            }
            
            // Remove loading class and make visible
            requestAnimationFrame(() => {
                sidebar.classList.remove('loading');
                sidebar.style.opacity = '1';
            });
            
            // Handle active menu item highlighting
            const menuLinks = document.querySelectorAll('.sidebar ul li a');
            const currentPath = window.location.pathname;
            menuLinks.forEach(link => {
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                }
            });

            // Handle window resize with throttling
            const handleResize = throttle(function() {
                if (window.innerWidth > 768) {
                    closeMobileMenu();
                }
            }, 250);
            
            window.addEventListener('resize', handleResize);
            
            // Prevent double-tap zoom on mobile
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
        });
    </script>

    {% block extra_scripts %}{% endblock %}
</body>
</html>
